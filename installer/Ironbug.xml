<project>
    <shortName>Ironbug</shortName>
    <fullName>Ironbug for Ladybug Tools</fullName>
    <version>1.0</version>
    <leftImage>../../Pollination/rhino-plugin/installer/config/logo.png</leftImage>
    <logoImage>../../Pollination/rhino-plugin/installer/config/logo.png</logoImage>
    <wmImage>../../Pollination/rhino-plugin/installer/config/logo.png</wmImage>
    <componentList>
        <component>
            <name>plugin</name>
            <description>Plugin</description>
            <canBeEdited>0</canBeEdited>
            <selected>1</selected>
            <show>1</show>
            <folderList>
                <folder>
                    <description>Plugin</description>
                    <destination>${IBFolder}</destination>
                    <name>plugin</name>
                    <platforms>all</platforms>
                    <distributionFileList>
                        <distributionDirectory>
                            <origin>plugin</origin>
                        </distributionDirectory>
                    </distributionFileList>
                </folder>
            </folderList>
        </component>
    </componentList>
    <preInstallationActionList>
        <throwError>
            <text>This installer only works for Windows x64</text>
            <ruleList>
                <platformTest>
                    <negate>1</negate>
                    <type>windows-x64</type>
                </platformTest>
            </ruleList>
        </throwError>
        <throwError>
            <text>Please close the Rhino before installing!</text>
            <ruleList>
                <processTest>
                    <logic>is_running</logic>
                    <name>Rhino.exe</name>
                </processTest>
            </ruleList>
        </throwError>
    </preInstallationActionList>
    <readyToInstallActionList>
        <actionGroup>
            <progressText>Removing old versions</progressText>
            <actionList>
                <deleteFile>
                    <path>C:\Ironbug</path>
                    <progressText>Removing ${installdir}</progressText>
                    <ruleList>
                        <fileExists>
                            <path>${installdir}</path>
                        </fileExists>
                    </ruleList>
                </deleteFile>
                <deleteFile>
                    <path>${windows_folder_appdata}\Grasshopper\Libraries\Ironbug.ghlink</path>
                </deleteFile>
                <deleteFile>
                    <path>${installdir}/grasshopper/ironbug</path>
                    <progressText>Removing ${installdir}</progressText>
                    <ruleList>
                        <fileExists>
                            <path>${installdir}</path>
                        </fileExists>
                    </ruleList>
                </deleteFile>
                <registryFind>
                    <dataPattern>Ironbug</dataPattern>
                    <findAll>1</findAll>
                    <keyPattern>*</keyPattern>
                    <namePattern>DisplayName</namePattern>
                    <rootKey>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\${product_fullname}</rootKey>
                    <variable>oldInstallerPath</variable>
                </registryFind>
                <foreach>
                    <values>${oldInstallerPath}</values>
                    <variables>key name value</variables>
                    <actionList>
                        <registryGet>
                            <key>${key}</key>
                            <name>InstallLocation</name>
                            <variable>PreInstallLocation</variable>
                        </registryGet>
                        <registryDelete>
                            <key>${key}</key>
                            <name></name>
                            <progressText>Removing ${key}</progressText>
                        </registryDelete>
                        <deleteFile>
                            <path>${PreInstallLocation}</path>
                            <progressText>Removing ${PreInstallLocation}</progressText>
                            <ruleList>
                                <fileExists>
                                    <path>${PreInstallLocation}</path>
                                </fileExists>
                            </ruleList>
                        </deleteFile>
                    </actionList>
                </foreach>
            </actionList>
        </actionGroup>
    </readyToInstallActionList>
    <allowComponentSelection>1</allowComponentSelection>
    <compressionAlgorithm>lzma-ultra</compressionAlgorithm>
    <disableSplashScreen>1</disableSplashScreen>
    <enableRollback>0</enableRollback>
    <enableTimestamp>1</enableTimestamp>
    <enableUpx>1</enableUpx>
    <height>500</height>
    <installationScope>allusers</installationScope>
    <osxApplicationBundleIcon>../../Pollination/rhino-plugin/installer/config/logo.icns</osxApplicationBundleIcon>
    <osxUninstallerApplicationBundleIcon>../../Pollination/rhino-plugin/installer/config/logo.icns</osxUninstallerApplicationBundleIcon>
    <productComments>${project.version}</productComments>
    <productContact>info@pollination.cloud</productContact>
    <productDisplayIcon>${installdir}/logo.ico</productDisplayIcon>
    <productUrlInfoAbout>https://www.pollination.cloud</productUrlInfoAbout>
    <requireInstallationByRootUser>1</requireInstallationByRootUser>
    <saveRelativePaths>1</saveRelativePaths>
    <showFileUnpackingProgress>0</showFileUnpackingProgress>
    <singleInstanceCheck>1</singleInstanceCheck>
    <vendor>Ironbug</vendor>
    <width>700</width>
    <windowsARPRegistryPrefix>${product_fullname}</windowsARPRegistryPrefix>
    <windowsExecutableIcon>../../Pollination/rhino-plugin/installer/config/logo.ico</windowsExecutableIcon>
    <windowsResourceFileVersion>1.4.0</windowsResourceFileVersion>
    <windowsUninstallerExecutableIcon>../../Pollination/rhino-plugin/installer/config/logo.ico</windowsUninstallerExecutableIcon>
    <installationAbortedActionList>
        <deleteFile>
            <path>${IBFolder}</path>
        </deleteFile>
    </installationAbortedActionList>
    <parameterList>
        <directoryParameter>
            <name>installdir</name>
            <description>Installation Directory</description>
            <explanation>Please specify the directory where the Ladybug Tools is installed. (By default: C:\Program Files\ladybug_tools) </explanation>
            <value></value>
            <default>${LBTFolder}</default>
            <allowEmptyValue>0</allowEmptyValue>
            <cliOptionName>TargetDir</cliOptionName>
            <mustBeWritable>1</mustBeWritable>
            <mustExist>0</mustExist>
            <width>70</width>
            <postShowPageActionList>
                <setInstallerVariable>
                    <name>IBFolder</name>
                    <value>${installdir}/grasshopper/ironbug</value>
                </setInstallerVariable>
            </postShowPageActionList>
            <preShowPageActionList>
                <actionGroup>
                    <actionList>
                        <setInstallerVariable>
                            <name>lbt</name>
                            <value>${platform_install_prefix}/ladybug_tools</value>
                            <ruleList>
                                <fileExists>
                                    <path>${platform_install_prefix}/ladybug_tools/grasshopper</path>
                                </fileExists>
                            </ruleList>
                        </setInstallerVariable>
                        <setInstallerVariable>
                            <name>lbt</name>
                            <value>${windows_folder_profile}/ladybug_tools</value>
                            <ruleList>
                                <fileExists>
                                    <path>${windows_folder_profile}/ladybug_tools/grasshopper</path>
                                </fileExists>
                            </ruleList>
                        </setInstallerVariable>
                        <showInfo>
                            <text>Failed to find the Ladybug Tools installation folder. You have to set the path manually!</text>
                            <ruleList>
                                <fileExists>
                                    <negate>1</negate>
                                    <path>${lbt}</path>
                                </fileExists>
                            </ruleList>
                        </showInfo>
                        <showInfo>
                            <text>Found ${lbt}</text>
                        </showInfo>
                        <setInstallerVariable>
                            <name>installdir</name>
                            <value>${lbt}</value>
                            <ruleList>
                                <fileExists>
                                    <path>${lbt}</path>
                                </fileExists>
                            </ruleList>
                        </setInstallerVariable>
                    </actionList>
                </actionGroup>
            </preShowPageActionList>
            <validationActionList>
                <throwError>
                    <text>The installation directory contains non ASCII characters. This is currently not supported!
Please choose a different path.</text>
                    <ruleList>
                        <stringTest>
                            <text>${installdir}</text>
                            <type>not_ascii</type>
                        </stringTest>
                    </ruleList>
                </throwError>
            </validationActionList>
        </directoryParameter>
        <directoryParameter>
            <name>IBFolder</name>
            <description></description>
            <explanation></explanation>
            <value></value>
            <default></default>
            <allowEmptyValue>0</allowEmptyValue>
            <ask>0</ask>
            <cliOptionShow>0</cliOptionShow>
            <mustBeWritable>1</mustBeWritable>
            <mustExist>0</mustExist>
            <width>40</width>
            <postShowPageActionList>
                <showInfo>
                    <text>${IBFolder}</text>
                </showInfo>
            </postShowPageActionList>
        </directoryParameter>
    </parameterList>
</project>

